(function(b,a){if(typeof define==="function"&&define.amd){define(["underscore","backbone"],function(c,d){return a(c||b._,d||b.Backbone)})}else{a(_,Backbone)}}(this,function(a,b){function d(){return(((1+Math.random())*65536)|0).toString(16).substring(1)}function c(){return(d()+d()+"-"+d()+"-"+d()+"-"+d()+"-"+d()+d()+d())}b.LocalStorage=window.Store=function(e){this.name=e;var f=this.localStorage().getItem(this.name);this.records=(f&&f.split(","))||[]};a.extend(b.LocalStorage.prototype,{save:function(){this.localStorage().setItem(this.name,this.records.join(","))},create:function(e){if(!e.id){e.id=c();e.set(e.idAttribute,e.id)}this.localStorage().setItem(this.name+"-"+e.id,JSON.stringify(e));this.records.push(e.id.toString());this.save();return this.find(e)},update:function(e){this.localStorage().setItem(this.name+"-"+e.id,JSON.stringify(e));if(!a.include(this.records,e.id.toString())){this.records.push(e.id.toString())}this.save();return this.find(e)},find:function(e){return this.jsonData(this.localStorage().getItem(this.name+"-"+e.id))},findAll:function(){return a(this.records).chain().map(function(e){return this.jsonData(this.localStorage().getItem(this.name+"-"+e))},this).compact().value()},destroy:function(e){if(e.isNew()){return false}this.localStorage().removeItem(this.name+"-"+e.id);this.records=a.reject(this.records,function(f){return f===e.id.toString()});this.save();return e},localStorage:function(){return localStorage},jsonData:function(e){return e&&JSON.parse(e)}});b.LocalStorage.sync=window.Store.sync=b.localSync=function(g,h,i){var k=h.localStorage||h.collection.localStorage;var j,f,l=$.Deferred&&$.Deferred();try{switch(g){case"read":j=h.id!=undefined?k.find(h):k.findAll();break;case"create":j=k.create(h);break;case"update":j=k.update(h);break;case"delete":j=k.destroy(h);break}}catch(e){if(e.code===DOMException.QUOTA_EXCEEDED_ERR&&window.localStorage.length===0){f="Private browsing is unsupported"}else{f=e.message}}if(j){h.trigger("sync",h,j,i);if(i&&i.success){i.success(j)}if(l){l.resolve(j)}}else{f=f?f:"Record Not Found";if(i&&i.error){i.error(f)}if(l){l.reject(f)}}if(i&&i.complete){i.complete(j)}return l&&l.promise()};b.ajaxSync=b.sync;b.getSyncMethod=function(e){if(e.localStorage||(e.collection&&e.collection.localStorage)){return b.localSync}return b.ajaxSync};b.sync=function(e,f,g){return b.getSyncMethod(f).apply(this,[e,f,g])};return b.LocalStorage}));