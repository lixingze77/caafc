(function(d){var f=(typeof self=="object"&&self.self===self&&self)||(typeof global=="object"&&global.global===global&&global);if(typeof define==="function"&&define.amd){define(["underscore","jquery","exports"],function(g,e,h){f.Backbone=d(f,h,g,e)})}else{if(typeof exports!=="undefined"){var b=require("underscore"),a;try{a=require("jquery")}catch(c){}d(f,exports,b,a)}else{f.Backbone=d(f,{},f._,(f.jQuery||f.Zepto||f.ender||f.$))}}})(function(C,f,b,a){var B=C.Backbone;var H=Array.prototype.slice;f.VERSION="1.3.3";f.$=a;f.noConflict=function(){C.Backbone=B;return this};f.emulateHTTP=false;f.emulateJSON=false;var c=function(R,S,Q){switch(R){case 1:return function(){return b[S](this[Q])};case 2:return function(T){return b[S](this[Q],T)};case 3:return function(U,T){return b[S](this[Q],g(U,this),T)};case 4:return function(V,U,T){return b[S](this[Q],g(V,this),U,T)};default:return function(){var T=H.call(arguments);T.unshift(this[Q]);return b[S].apply(b,T)}}};var e=function(R,S,Q){b.each(S,function(T,U){if(b[U]){R.prototype[U]=c(T,U,Q)}})};var g=function(R,Q){if(b.isFunction(R)){return R}if(b.isObject(R)&&!Q._isModel(R)){return t(R)}if(b.isString(R)){return function(S){return S.get(R)}}return R};var t=function(Q){var R=b.matches(Q);return function(S){return R(S.attributes)}};var l=f.Events={};var n=/\s+/;var m=function(T,R,U,Q,W){var S=0,V;if(U&&typeof U==="object"){if(Q!==void 0&&"context" in W&&W.context===void 0){W.context=Q}for(V=b.keys(U);S<V.length;S++){R=m(T,R,V[S],U[V[S]],W)}}else{if(U&&n.test(U)){for(V=U.split(n);S<V.length;S++){R=T(R,V[S],Q,W)}}else{R=T(R,U,Q,W)}}return R};l.on=function(S,Q,R){return q(this,S,Q,R)};var q=function(V,U,Q,R,T){V._events=m(x,V._events||{},U,Q,{context:R,ctx:V,listening:T});if(T){var S=V._listeners||(V._listeners={});S[T.id]=T}return V};l.listenTo=function(V,U,Q){if(!V){return this}var R=V._listenId||(V._listenId=b.uniqueId("l"));var T=this._listeningTo||(this._listeningTo={});var S=T[R];if(!S){var W=this._listenId||(this._listenId=b.uniqueId("l"));S=T[R]={obj:V,objId:R,id:W,listeningTo:T,count:0}}q(V,U,Q,this,S);return this};var x=function(T,W,Q,X){if(Q){var U=T[W]||(T[W]=[]);var R=X.context,S=X.ctx,V=X.listening;if(V){V.count++}U.push({callback:Q,context:R,ctx:R||S,listening:V})}return T};l.off=function(S,Q,R){if(!this._events){return this}this._events=m(w,this._events,S,Q,{context:R,listeners:this._listeners});return this};l.stopListening=function(W,V,Q){var U=this._listeningTo;if(!U){return this}var S=W?[W._listenId]:b.keys(U);for(var R=0;R<S.length;R++){var T=U[S[R]];if(!T){break}T.obj.off(V,Q,this)}return this};var w=function(S,aa,Q,ac){if(!S){return}var V=0,Z;var R=ac.context,Y=ac.listeners;if(!aa&&!Q&&!R){var W=b.keys(Y);for(;V<W.length;V++){Z=Y[W[V]];delete Y[Z.id];delete Z.listeningTo[Z.objId]}return}var ab=aa?[aa]:b.keys(S);for(;V<ab.length;V++){aa=ab[V];var U=S[aa];if(!U){break}var ad=[];for(var X=0;X<U.length;X++){var T=U[X];if(Q&&Q!==T.callback&&Q!==T.callback._callback||R&&R!==T.context){ad.push(T)}else{Z=T.listening;if(Z&&--Z.count===0){delete Y[Z.id];delete Z.listeningTo[Z.objId]}}}if(ad.length){S[aa]=ad}else{delete S[aa]}}return S};l.once=function(T,Q,R){var S=m(y,{},T,Q,b.bind(this.off,this));if(typeof T==="string"&&R==null){Q=void 0}return this.on(S,Q,R)};l.listenToOnce=function(T,S,Q){var R=m(y,{},S,Q,b.bind(this.stopListening,this,T));return this.listenTo(T,R)};var y=function(R,S,Q,T){if(Q){var U=R[S]=b.once(function(){T(S,U);Q.apply(this,arguments)});U._callback=Q}return R};l.trigger=function(T){if(!this._events){return this}var S=Math.max(0,arguments.length-1);var Q=Array(S);for(var R=0;R<S;R++){Q[R]=arguments[R+1]}m(K,this._events,T,void 0,Q);return this};var K=function(V,U,S,R){if(V){var T=V[U];var Q=V.all;if(T&&Q){Q=Q.slice()}if(T){L(T,R)}if(Q){L(Q,[U].concat(R))}}return V};var L=function(V,T){var U,W=-1,X=V.length,Q=T[0],R=T[1],S=T[2];switch(T.length){case 0:while(++W<X){(U=V[W]).callback.call(U.ctx)}return;case 1:while(++W<X){(U=V[W]).callback.call(U.ctx,Q)}return;case 2:while(++W<X){(U=V[W]).callback.call(U.ctx,Q,R)}return;case 3:while(++W<X){(U=V[W]).callback.call(U.ctx,Q,R,S)}return;default:while(++W<X){(U=V[W]).callback.apply(U.ctx,T)}return}};l.bind=l.on;l.unbind=l.off;b.extend(f,l);var s=f.Model=function(Q,T){var R=Q||{};T||(T={});this.cid=b.uniqueId(this.cidPrefix);this.attributes={};if(T.collection){this.collection=T.collection}if(T.parse){R=this.parse(R,T)||{}}var S=b.result(this,"defaults");R=b.defaults(b.extend({},S,R),S);this.set(R,T);this.changed={};this.initialize.apply(this,arguments)};b.extend(s.prototype,l,{changed:null,validationError:null,idAttribute:"id",cidPrefix:"c",initialize:function(){},toJSON:function(Q){return b.clone(this.attributes)},sync:function(){return f.sync.apply(this,arguments)},get:function(Q){return this.attributes[Q]},escape:function(Q){return b.escape(this.get(Q))},has:function(Q){return this.get(Q)!=null},matches:function(Q){return !!b.iteratee(Q,this)(this.attributes)},set:function(X,ac,Y){if(X==null){return this}var R;if(typeof X==="object"){R=X;Y=ac}else{(R={})[X]=ac}Y||(Y={});if(!this._validate(R,Y)){return false}var ab=Y.unset;var aa=Y.silent;var T=[];var U=this._changing;this._changing=true;if(!U){this._previousAttributes=b.clone(this.attributes);this.changed={}}var V=this.attributes;var S=this.changed;var Z=this._previousAttributes;for(var Q in R){ac=R[Q];if(!b.isEqual(V[Q],ac)){T.push(Q)}if(!b.isEqual(Z[Q],ac)){S[Q]=ac}else{delete S[Q]}ab?delete V[Q]:V[Q]=ac}if(this.idAttribute in R){this.id=this.get(this.idAttribute)}if(!aa){if(T.length){this._pending=Y}for(var W=0;W<T.length;W++){this.trigger("change:"+T[W],this,V[T[W]],Y)}}if(U){return this}if(!aa){while(this._pending){Y=this._pending;this._pending=false;this.trigger("change",this,Y)}}this._pending=false;this._changing=false;return this},unset:function(Q,R){return this.set(Q,void 0,b.extend({},R,{unset:true}))},clear:function(S){var Q={};for(var R in this.attributes){Q[R]=void 0}return this.set(Q,b.extend({},S,{unset:true}))},hasChanged:function(Q){if(Q==null){return !b.isEmpty(this.changed)}return b.has(this.changed,Q)},changedAttributes:function(S){if(!S){return this.hasChanged()?b.clone(this.changed):false}var T=this._changing?this._previousAttributes:this.attributes;var R={};for(var Q in S){var U=S[Q];if(b.isEqual(T[Q],U)){continue}R[Q]=U}return b.size(R)?R:false},previous:function(Q){if(Q==null||!this._previousAttributes){return null}return this._previousAttributes[Q]},previousAttributes:function(){return b.clone(this._previousAttributes)},fetch:function(R){R=b.extend({parse:true},R);var Q=this;var S=R.success;R.success=function(T){var U=R.parse?Q.parse(T,R):T;if(!Q.set(U,R)){return false}if(S){S.call(R.context,Q,T,R)}Q.trigger("sync",Q,T,R)};P(this,R);return this.sync("read",this,R)},save:function(S,X,V){var R;if(S==null||typeof S==="object"){R=S;V=X}else{(R={})[S]=X}V=b.extend({validate:true,parse:true},V);var Y=V.wait;if(R&&!Y){if(!this.set(R,V)){return false}}else{if(!this._validate(R,V)){return false}}var U=this;var W=V.success;var Q=this.attributes;V.success=function(aa){U.attributes=Q;var ab=V.parse?U.parse(aa,V):aa;if(Y){ab=b.extend({},R,ab)}if(ab&&!U.set(ab,V)){return false}if(W){W.call(V.context,U,aa,V)}U.trigger("sync",U,aa,V)};P(this,V);if(R&&Y){this.attributes=b.extend({},Q,R)}var T=this.isNew()?"create":(V.patch?"patch":"update");if(T==="patch"&&!V.attrs){V.attrs=R}var Z=this.sync(T,this,V);this.attributes=Q;return Z},destroy:function(S){S=S?b.clone(S):{};var R=this;var T=S.success;var U=S.wait;var Q=function(){R.stopListening();R.trigger("destroy",R,R.collection,S)};S.success=function(W){if(U){Q()}if(T){T.call(S.context,R,W,S)}if(!R.isNew()){R.trigger("sync",R,W,S)}};var V=false;if(this.isNew()){b.defer(S.success)}else{P(this,S);V=this.sync("delete",this,S)}if(!U){Q()}return V},url:function(){var Q=b.result(this,"urlRoot")||b.result(this.collection,"url")||M();if(this.isNew()){return Q}var R=this.get(this.idAttribute);return Q.replace(/[^\/]$/,"$&/")+encodeURIComponent(R)},parse:function(R,Q){return R},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return !this.has(this.idAttribute)},isValid:function(Q){return this._validate({},b.extend({},Q,{validate:true}))},_validate:function(Q,S){if(!S.validate||!this.validate){return true}Q=b.extend({},this.attributes,Q);var R=this.validationError=this.validate(Q,S)||null;if(!R){return true}this.trigger("invalid",this,R,b.extend(S,{validationError:R}));return false}});var u={keys:1,values:1,pairs:1,invert:1,pick:0,omit:0,chain:1,isEmpty:1};e(s,u,"attributes");var h=f.Collection=function(Q,R){R||(R={});if(R.model){this.model=R.model}if(R.comparator!==void 0){this.comparator=R.comparator}this._reset();this.initialize.apply(this,arguments);if(Q){this.reset(Q,b.extend({silent:true},R))}};var G={add:true,remove:true,merge:true};var d={add:true,remove:false};var J=function(Q,T,R){R=Math.min(Math.max(R,0),Q.length);var V=Array(Q.length-R);var U=T.length;var S;for(S=0;S<V.length;S++){V[S]=Q[S+R]}for(S=0;S<U;S++){Q[S+R]=T[S]}for(S=0;S<V.length;S++){Q[S+U+R]=V[S]}};b.extend(h.prototype,l,{model:s,initialize:function(){},toJSON:function(Q){return this.map(function(R){return R.toJSON(Q)})},sync:function(){return f.sync.apply(this,arguments)},add:function(Q,R){return this.set(Q,b.extend({merge:false},R,d))},remove:function(Q,R){R=b.extend({},R);var T=!b.isArray(Q);Q=T?[Q]:Q.slice();var S=this._removeModels(Q,R);if(!R.silent&&S.length){R.changes={added:[],merged:[],removed:S};this.trigger("update",this,R)}return T?S[0]:S},set:function(Y,Z){if(Y==null){return}Z=b.extend({},G,Z);if(Z.parse&&!this._isModel(Y)){Y=this.parse(Y,Z)||[]}var ae=!b.isArray(Y);Y=ae?[Y]:Y.slice();var R=Z.at;if(R!=null){R=+R}if(R>this.length){R=this.length}if(R<0){R+=this.length+1}var ad=[];var ai=[];var aj=[];var ak=[];var X={};var Q=Z.add;var V=Z.merge;var ab=Z.remove;var af=false;var ag=this.comparator&&R==null&&Z.sort!==false;var ah=b.isString(this.comparator)?this.comparator:null;var W,U;for(U=0;U<Y.length;U++){W=Y[U];var T=this.get(W);if(T){if(V&&W!==T){var S=this._isModel(W)?W.attributes:W;if(Z.parse){S=T.parse(S,Z)}T.set(S,Z);aj.push(T);if(ag&&!af){af=T.hasChanged(ah)}}if(!X[T.cid]){X[T.cid]=true;ad.push(T)}Y[U]=T}else{if(Q){W=Y[U]=this._prepareModel(W,Z);if(W){ai.push(W);this._addReference(W,Z);X[W.cid]=true;ad.push(W)}}}}if(ab){for(U=0;U<this.length;U++){W=this.models[U];if(!X[W.cid]){ak.push(W)}}if(ak.length){this._removeModels(ak,Z)}}var aa=false;var ac=!ag&&Q&&ab;if(ad.length&&ac){aa=this.length!==ad.length||b.some(this.models,function(am,al){return am!==ad[al]});this.models.length=0;J(this.models,ad,0);this.length=this.models.length}else{if(ai.length){if(ag){af=true}J(this.models,ai,R==null?this.length:R);this.length=this.models.length}}if(af){this.sort({silent:true})}if(!Z.silent){for(U=0;U<ai.length;U++){if(R!=null){Z.index=R+U}W=ai[U];W.trigger("add",W,this,Z)}if(af||aa){this.trigger("sort",this,Z)}if(ai.length||ak.length||aj.length){Z.changes={added:ai,removed:ak,merged:aj};this.trigger("update",this,Z)}}return ae?Y[0]:Y},reset:function(R,S){S=S?b.clone(S):{};for(var Q=0;Q<this.models.length;Q++){this._removeReference(this.models[Q],S)}S.previousModels=this.models;this._reset();R=this.add(R,b.extend({silent:true},S));if(!S.silent){this.trigger("reset",this,S)}return R},push:function(Q,R){return this.add(Q,b.extend({at:this.length},R))},pop:function(R){var Q=this.at(this.length-1);return this.remove(Q,R)},unshift:function(Q,R){return this.add(Q,b.extend({at:0},R))},shift:function(R){var Q=this.at(0);return this.remove(Q,R)},slice:function(){return H.apply(this.models,arguments)},get:function(Q){if(Q==null){return void 0}return this._byId[Q]||this._byId[this.modelId(Q.attributes||Q)]||Q.cid&&this._byId[Q.cid]},has:function(Q){return this.get(Q)!=null},at:function(Q){if(Q<0){Q+=this.length}return this.models[Q]},where:function(Q,R){return this[R?"find":"filter"](Q)},findWhere:function(Q){return this.where(Q,true)},sort:function(S){var Q=this.comparator;if(!Q){throw new Error("Cannot sort a set without a comparator")}S||(S={});var R=Q.length;if(b.isFunction(Q)){Q=b.bind(Q,this)}if(R===1||b.isString(Q)){this.models=this.sortBy(Q)}else{this.models.sort(Q)}if(!S.silent){this.trigger("sort",this,S)}return this},pluck:function(Q){return this.map(Q+"")},fetch:function(R){R=b.extend({parse:true},R);var S=R.success;var Q=this;R.success=function(U){var T=R.reset?"reset":"set";Q[T](U,R);if(S){S.call(R.context,Q,U,R)}Q.trigger("sync",Q,U,R)};P(this,R);return this.sync("read",this,R)},create:function(R,S){S=S?b.clone(S):{};var U=S.wait;R=this._prepareModel(R,S);if(!R){return false}if(!U){this.add(R,S)}var Q=this;var T=S.success;S.success=function(W,X,V){if(U){Q.add(W,V)}if(T){T.call(V.context,W,X,V)}};R.save(null,S);return R},parse:function(R,Q){return R},clone:function(){return new this.constructor(this.models,{model:this.model,comparator:this.comparator})},modelId:function(Q){return Q[this.model.prototype.idAttribute||"id"]},_reset:function(){this.length=0;this.models=[];this._byId={}},_prepareModel:function(Q,S){if(this._isModel(Q)){if(!Q.collection){Q.collection=this}return Q}S=S?b.clone(S):{};S.collection=this;var R=new this.model(Q,S);if(!R.validationError){return R}this.trigger("invalid",this,R.validationError,S);return false},_removeModels:function(U,V){var W=[];for(var Q=0;Q<U.length;Q++){var T=this.get(U[Q]);if(!T){continue}var S=this.indexOf(T);this.models.splice(S,1);this.length--;delete this._byId[T.cid];var R=this.modelId(T.attributes);if(R!=null){delete this._byId[R]}if(!V.silent){V.index=S;T.trigger("remove",T,this,V)}W.push(T);this._removeReference(T,V)}return W},_isModel:function(Q){return Q instanceof s},_addReference:function(R,S){this._byId[R.cid]=R;var Q=this.modelId(R.attributes);if(Q!=null){this._byId[Q]=R}R.on("all",this._onModelEvent,this)},_removeReference:function(R,S){delete this._byId[R.cid];var Q=this.modelId(R.attributes);if(Q!=null){delete this._byId[Q]}if(this===R.collection){delete R.collection}R.off("all",this._onModelEvent,this)},_onModelEvent:function(R,T,Q,U){if(T){if((R==="add"||R==="remove")&&Q!==this){return}if(R==="destroy"){this.remove(T,U)}if(R==="change"){var V=this.modelId(T.previousAttributes());var S=this.modelId(T.attributes);if(V!==S){if(V!=null){delete this._byId[V]}if(S!=null){this._byId[S]=T}}}}this.trigger.apply(this,arguments)}});var i={forEach:3,each:3,map:3,collect:3,reduce:0,foldl:0,inject:0,reduceRight:0,foldr:0,find:3,detect:3,filter:3,select:3,reject:3,every:3,all:3,some:3,any:3,include:3,includes:3,contains:3,invoke:0,max:3,min:3,toArray:1,size:1,first:3,head:3,take:3,initial:3,rest:3,tail:3,drop:3,last:3,without:0,difference:0,indexOf:3,shuffle:1,lastIndexOf:3,isEmpty:1,chain:1,sample:3,partition:3,groupBy:3,countBy:3,sortBy:3,indexBy:3,findIndex:3,findLastIndex:3};e(h,i,"models");var N=f.View=function(Q){this.cid=b.uniqueId("view");b.extend(this,b.pick(Q,O));this._ensureElement();this.initialize.apply(this,arguments)};var j=/^(\S+)\s*(.*)$/;var O=["model","collection","el","id","attributes","className","tagName","events"];b.extend(N.prototype,l,{tagName:"div",$:function(Q){return this.$el.find(Q)},initialize:function(){},render:function(){return this},remove:function(){this._removeElement();this.stopListening();return this},_removeElement:function(){this.$el.remove()},setElement:function(Q){this.undelegateEvents();this._setElement(Q);this.delegateEvents();return this},_setElement:function(Q){this.$el=Q instanceof f.$?Q:f.$(Q);this.el=this.$el[0]},delegateEvents:function(Q){Q||(Q=b.result(this,"events"));if(!Q){return this}this.undelegateEvents();for(var R in Q){var T=Q[R];if(!b.isFunction(T)){T=this[T]}if(!T){continue}var S=R.match(j);this.delegate(S[1],S[2],b.bind(T,this))}return this},delegate:function(Q,S,R){this.$el.on(Q+".delegateEvents"+this.cid,S,R);return this},undelegateEvents:function(){if(this.$el){this.$el.off(".delegateEvents"+this.cid)}return this},undelegate:function(Q,S,R){this.$el.off(Q+".delegateEvents"+this.cid,S,R);return this},_createElement:function(Q){return document.createElement(Q)},_ensureElement:function(){if(!this.el){var Q=b.extend({},b.result(this,"attributes"));if(this.id){Q.id=b.result(this,"id")}if(this.className){Q["class"]=b.result(this,"className")}this.setElement(this._createElement(b.result(this,"tagName")));this._setAttributes(Q)}else{this.setElement(b.result(this,"el"))}},_setAttributes:function(Q){this.$el.attr(Q)}});f.sync=function(S,T,U){var W=r[S];b.defaults(U||(U={}),{emulateHTTP:f.emulateHTTP,emulateJSON:f.emulateJSON});var V={type:W,dataType:"json"};if(!U.url){V.url=b.result(T,"url")||M()}if(U.data==null&&T&&(S==="create"||S==="update"||S==="patch")){V.contentType="application/json";V.data=JSON.stringify(U.attrs||T.toJSON(U))}if(U.emulateJSON){V.contentType="application/x-www-form-urlencoded";V.data=V.data?{model:V.data}:{}}if(U.emulateHTTP&&(W==="PUT"||W==="DELETE"||W==="PATCH")){V.type="POST";if(U.emulateJSON){V.data._method=W}var Q=U.beforeSend;U.beforeSend=function(Y){Y.setRequestHeader("X-HTTP-Method-Override",W);if(Q){return Q.apply(this,arguments)}}}if(V.type!=="GET"&&!U.emulateJSON){V.processData=false}var R=U.error;U.error=function(aa,Z,Y){U.textStatus=Z;U.errorThrown=Y;if(R){R.call(U.context,aa,Z,Y)}};var X=U.xhr=f.ajax(b.extend(V,U));T.trigger("request",T,X,U);return X};var r={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};f.ajax=function(){return f.$.ajax.apply(f.$,arguments)};var E=f.Router=function(Q){Q||(Q={});if(Q.routes){this.routes=Q.routes}this._bindRoutes();this.initialize.apply(this,arguments)};var z=/\((.*?)\)/g;var v=/(\(\?)?:\w+/g;var I=/\*\w+/g;var k=/[\-{}\[\]+?.,\\\^$|#\s]/g;b.extend(E.prototype,l,{initialize:function(){},route:function(S,R,Q){if(!b.isRegExp(S)){S=this._routeToRegExp(S)}if(b.isFunction(R)){Q=R;R=""}if(!Q){Q=this[R]}var T=this;f.history.route(S,function(V){var U=T._extractParameters(S,V);if(T.execute(Q,U,R)!==false){T.trigger.apply(T,["route:"+R].concat(U));T.trigger("route",R,U);f.history.trigger("route",T,R,U)}});return this},execute:function(R,Q,S){if(R){R.apply(this,Q)}},navigate:function(Q,R){f.history.navigate(Q,R);return this},_bindRoutes:function(){if(!this.routes){return}this.routes=b.result(this,"routes");var Q,R=b.keys(this.routes);while((Q=R.pop())!=null){this.route(Q,this.routes[Q])}},_routeToRegExp:function(Q){Q=Q.replace(k,"\\$&").replace(z,"(?:$1)?").replace(v,function(R,S){return S?R:"([^/?]+)"}).replace(I,"([^?]*?)");return new RegExp("^"+Q+"(?:\\?([\\s\\S]*))?$")},_extractParameters:function(S,Q){var R=S.exec(Q).slice(1);return b.map(R,function(U,T){if(T===R.length-1){return U||null}return U?decodeURIComponent(U):null})}});var p=f.History=function(){this.handlers=[];this.checkUrl=b.bind(this.checkUrl,this);if(typeof window!=="undefined"){this.location=window.location;this.history=window.history}};var F=/^[#\/]|\s+$/g;var D=/^\/+|\/+$/g;var A=/#.*$/;p.started=false;b.extend(p.prototype,l,{interval:50,atRoot:function(){var Q=this.location.pathname.replace(/[^\/]$/,"$&/");return Q===this.root&&!this.getSearch()},matchRoot:function(){var Q=this.decodeFragment(this.location.pathname);var R=Q.slice(0,this.root.length-1)+"/";return R===this.root},decodeFragment:function(Q){return decodeURI(Q.replace(/%25/g,"%2525"))},getSearch:function(){var Q=this.location.href.replace(/#.*/,"").match(/\?.+/);return Q?Q[0]:""},getHash:function(R){var Q=(R||this).location.href.match(/#(.*)$/);return Q?Q[1]:""},getPath:function(){var Q=this.decodeFragment(this.location.pathname+this.getSearch()).slice(this.root.length-1);return Q.charAt(0)==="/"?Q.slice(1):Q},getFragment:function(Q){if(Q==null){if(this._usePushState||!this._wantsHashChange){Q=this.getPath()}else{Q=this.getHash()}}return Q.replace(F,"")},start:function(T){if(p.started){throw new Error("Backbone.history has already been started")}p.started=true;this.options=b.extend({root:"/"},this.options,T);this.root=this.options.root;this._wantsHashChange=this.options.hashChange!==false;this._hasHashChange="onhashchange" in window&&(document.documentMode===void 0||document.documentMode>7);this._useHashChange=this._wantsHashChange&&this._hasHashChange;this._wantsPushState=!!this.options.pushState;this._hasPushState=!!(this.history&&this.history.pushState);this._usePushState=this._wantsPushState&&this._hasPushState;this.fragment=this.getFragment();this.root=("/"+this.root+"/").replace(D,"/");if(this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!this.atRoot()){var U=this.root.slice(0,-1)||"/";this.location.replace(U+"#"+this.getPath());return true}else{if(this._hasPushState&&this.atRoot()){this.navigate(this.getHash(),{replace:true})}}}if(!this._hasHashChange&&this._wantsHashChange&&!this._usePushState){this.iframe=document.createElement("iframe");this.iframe.src="javascript:0";this.iframe.style.display="none";this.iframe.tabIndex=-1;var R=document.body;var S=R.insertBefore(this.iframe,R.firstChild).contentWindow;S.document.open();S.document.close();S.location.hash="#"+this.fragment}var Q=window.addEventListener||function(V,W){return attachEvent("on"+V,W)};if(this._usePushState){Q("popstate",this.checkUrl,false)}else{if(this._useHashChange&&!this.iframe){Q("hashchange",this.checkUrl,false)}else{if(this._wantsHashChange){this._checkUrlInterval=setInterval(this.checkUrl,this.interval)}}}if(!this.options.silent){return this.loadUrl()}},stop:function(){var Q=window.removeEventListener||function(R,S){return detachEvent("on"+R,S)};if(this._usePushState){Q("popstate",this.checkUrl,false)}else{if(this._useHashChange&&!this.iframe){Q("hashchange",this.checkUrl,false)}}if(this.iframe){document.body.removeChild(this.iframe);this.iframe=null}if(this._checkUrlInterval){clearInterval(this._checkUrlInterval)}p.started=false},route:function(R,Q){this.handlers.unshift({route:R,callback:Q})},checkUrl:function(R){var Q=this.getFragment();if(Q===this.fragment&&this.iframe){Q=this.getHash(this.iframe.contentWindow)}if(Q===this.fragment){return false}if(this.iframe){this.navigate(Q)}this.loadUrl()},loadUrl:function(Q){if(!this.matchRoot()){return false}Q=this.fragment=this.getFragment(Q);return b.some(this.handlers,function(R){if(R.route.test(Q)){R.callback(Q);return true}})},navigate:function(Q,S){if(!p.started){return false}if(!S||S===true){S={trigger:!!S}}Q=this.getFragment(Q||"");var T=this.root;if(Q===""||Q.charAt(0)==="?"){T=T.slice(0,-1)||"/"}var U=T+Q;Q=this.decodeFragment(Q.replace(A,""));if(this.fragment===Q){return}this.fragment=Q;if(this._usePushState){this.history[S.replace?"replaceState":"pushState"]({},document.title,U)}else{if(this._wantsHashChange){this._updateHash(this.location,Q,S.replace);if(this.iframe&&Q!==this.getHash(this.iframe.contentWindow)){var R=this.iframe.contentWindow;if(!S.replace){R.document.open();R.document.close()}this._updateHash(R.location,Q,S.replace)}}else{return this.location.assign(U)}}if(S.trigger){return this.loadUrl(Q)}},_updateHash:function(S,Q,T){if(T){var R=S.href.replace(/(javascript:|#).*$/,"");S.replace(R+"#"+Q)}else{S.hash="#"+Q}}});f.history=new p;var o=function(S,T){var R=this;var Q;if(S&&b.has(S,"constructor")){Q=S.constructor}else{Q=function(){return R.apply(this,arguments)}}b.extend(Q,R,T);Q.prototype=b.create(R.prototype,S);Q.prototype.constructor=Q;Q.__super__=R.prototype;return Q};s.extend=h.extend=E.extend=N.extend=p.extend=o;var M=function(){throw new Error('A "url" property or function must be specified')};var P=function(R,S){var Q=S.error;S.error=function(T){if(Q){Q.call(S.context,R,T,S)}R.trigger("error",R,T,S)}};return f});